#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: git newtree <name> [branch-name]"
  echo ""
  echo "Creates a new git worktree in .tree/<name> directory."
  echo ""
  echo "Arguments:"
  echo "  <name>         Folder name in .tree/ for the worktree"
  echo "  [branch-name]  Branch name (defaults to <name>)"
  echo ""
  echo "Behavior:"
  echo "  • Creates .tree/ directory if it doesn't exist"
  echo "  • Creates worktree at .tree/<name>"
  echo "  • Creates new branch if it doesn't exist, or uses existing branch"
  echo "  • Copies .env and .envrc files to the worktree if present"
  echo ""
  echo "Examples:"
  echo "  git newtree feature-x          # Creates .tree/feature-x with branch 'feature-x'"
  echo "  git newtree fix main           # Creates .tree/fix using existing 'main' branch"
}

# Ensure we're inside a git repository
if ! git rev-parse --git-dir >/dev/null 2>&1; then
  echo "Error: not in a git repository" >&2
  exit 1
fi

if [[ ${1:-} == "-h" || ${1:-} == "--help" ]]; then
  usage
  exit 0
fi

if [[ -z ${1:-} ]]; then
  usage
  exit 1
fi

tree_name="$1"
branch_name="${2:-$1}"

mkdir -p .tree

dest_dir=".tree/$tree_name"

if git show-ref --verify --quiet "refs/heads/$branch_name"; then
  echo "Creating worktree at $dest_dir on existing branch '$branch_name'"
  git worktree add "$dest_dir" "$branch_name"
  echo "✓ Worktree created at $dest_dir"
  echo "✓ Using existing branch '$branch_name'"
else
  echo "Creating worktree at $dest_dir with new branch '$branch_name'"
  git worktree add "$dest_dir" -b "$branch_name"
  echo "✓ Worktree created at $dest_dir"
  echo "✓ New branch '$branch_name' created"
fi

# Copy local environment files if present
if [[ -f .env ]]; then
  if [[ -e "$dest_dir/.env" ]]; then
    echo "• .env already exists in $dest_dir; leaving it as is"
  else
    cp .env "$dest_dir/.env"
    echo "✓ Copied .env to $dest_dir/.env"
  fi
fi

if [[ -f .envrc ]]; then
  if [[ -e "$dest_dir/.envrc" ]]; then
    echo "• .envrc already exists in $dest_dir; leaving it as is"
  else
    cp .envrc "$dest_dir/.envrc"
    echo "✓ Copied .envrc to $dest_dir/.envrc"
  fi
fi

echo "To switch to this worktree: cd $dest_dir"

