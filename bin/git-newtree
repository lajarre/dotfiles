#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: git newtree <name> [branch-name]"
  echo ""
  echo "Creates a new git worktree in .tree/<name> directory."
  echo ""
  echo "Arguments:"
  echo "  <name>         Folder name in .tree/ for the worktree"
  echo "  [branch-name]  Branch name (defaults to <name>)"
  echo ""
  echo "Behavior:"
  echo "  • Verifies .tree/ is git-ignored (exits with error if not)"
  echo "  • Creates .tree/ directory if it doesn't exist"
  echo "  • Creates worktree at .tree/<name>"
  echo "  • Creates new branch if it doesn't exist, or uses existing branch"
  echo "  • Copies .env and .envrc to the worktree if present"
  echo "  • Symlinks .claude/settings.local.json from repo root (shared)"
  echo ""
  echo "Examples:"
  echo "  git newtree feature-x          # Creates .tree/feature-x with branch 'feature-x'"
  echo "  git newtree fix main           # Creates .tree/fix using existing 'main' branch"
}

# Ensure we're inside a git repository
if ! git rev-parse --git-dir >/dev/null 2>&1; then
  echo "Error: not in a git repository" >&2
  exit 1
fi

if [[ ${1:-} == "-h" || ${1:-} == "--help" ]]; then
  usage
  exit 0
fi

if [[ -z ${1:-} ]]; then
  usage
  exit 1
fi

tree_name="$1"
branch_name="${2:-$1}"

# Determine the repository root to avoid nesting .tree/ inside another worktree
# git-common-dir points to the main .git directory (or relative path to it)
git_common_dir=$(git rev-parse --git-common-dir)
repo_root=$(cd "$(dirname "$git_common_dir")" && pwd)
# Determine the root of the current worktree (source for config files)
current_root=$(git rev-parse --show-toplevel)

# Safety check: ensure .tree/ is git-ignored
if ! git -C "$repo_root" check-ignore -q .tree/; then
  echo "Error: .tree/ is not git-ignored in this repository" >&2
  echo "" >&2
  echo "To fix this, add the following line to $repo_root/.gitignore:" >&2
  echo "  .tree/" >&2
  echo "" >&2
  echo "Then commit the .gitignore change before creating worktrees." >&2
  exit 1
fi

mkdir -p "$repo_root/.tree"

dest_dir="$repo_root/.tree/$tree_name"

if git show-ref --verify --quiet "refs/heads/$branch_name"; then
  echo "Creating worktree at $dest_dir on existing branch '$branch_name'"
  git worktree add "$dest_dir" "$branch_name"
  echo "✓ Worktree created at $dest_dir"
  echo "✓ Using existing branch '$branch_name'"
else
  echo "Creating worktree at $dest_dir with new branch '$branch_name'"
  git worktree add "$dest_dir" -b "$branch_name"
  echo "✓ Worktree created at $dest_dir"
  echo "✓ New branch '$branch_name' created"
fi

# Copy local environment files if present in current worktree root
if [[ -f "$current_root/.env" ]]; then
  if [[ -e "$dest_dir/.env" ]]; then
    echo "• .env already exists in $dest_dir; leaving it as is"
  else
    cp "$current_root/.env" "$dest_dir/.env"
    echo "✓ Copied .env to $dest_dir/.env"
  fi
fi

if [[ -f "$current_root/.envrc" ]]; then
  if [[ -e "$dest_dir/.envrc" ]]; then
    echo "• .envrc already exists in $dest_dir; leaving it as is"
  else
    cp "$current_root/.envrc" "$dest_dir/.envrc"
    echo "✓ Copied .envrc to $dest_dir/.envrc"
  fi
fi

# Link .claude/settings.local.json from repo root if it exists
# This ensures all worktrees share the same local settings
if [[ -f "$repo_root/.claude/settings.local.json" ]]; then
  mkdir -p "$dest_dir/.claude"
  ln -s "$repo_root/.claude/settings.local.json" "$dest_dir/.claude/settings.local.json"
  echo "✓ Linked .claude/settings.local.json from repo root"
fi

echo "To switch to this worktree: cd $dest_dir"
echo ""
echo "Next step: run baseline tests in the new worktree to verify clean state"

