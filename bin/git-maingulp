#!/usr/bin/env bash
#
# git-maingulp - Rebase main onto a branch, push, and cleanup
#
# Merges work from a feature branch into main, pushes, and cleans up
# the worktree and branch. Must be run from the main branch.

set -euo pipefail

usage() {
  cat << 'EOF'
git maingulp - Rebase main onto a branch, push, and cleanup

USAGE:
    git maingulp <branch> <worktree-path>
    git maingulp --help | -h

DESCRIPTION:
    Completes a feature branch workflow by:
    1. Rebasing main onto the specified branch (fast-forward merge)
    2. Pushing main to the remote
    3. Removing the worktree at the specified path
    4. Deleting the local branch (only if fully merged)

    This command must be run from the 'main' branch.

ARGUMENTS:
    <branch>         Name of the branch to rebase onto main
    <worktree-path>  Path to the worktree directory to remove

EXAMPLES:
    git maingulp feature-x .tree/feature-x
    git maingulp fix-bug .tree/fix

NOTES:
    - Must be on 'main' branch to run this command
    - Branch will only be deleted if fully merged (uses git branch -d)
    - Worktree will be force-removed even if it has uncommitted changes
    - After running, main will contain all commits from the feature branch

EOF
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

if [[ $# -ne 2 ]]; then
  usage
  exit 1
fi

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "Error: not inside a git repository" >&2
  exit 1
fi

current=$(git rev-parse --abbrev-ref HEAD)
if [[ "$current" != "main" ]]; then
  echo "Error: must be on 'main' (currently on '$current')" >&2
  exit 1
fi

branch="$1"
worktree_path="$2"

# Verify branch exists
if ! git show-ref --verify --quiet "refs/heads/$branch"; then
  echo "Error: branch '$branch' does not exist" >&2
  exit 1
fi

# Verify worktree path exists
if [[ ! -d "$worktree_path" ]]; then
  # Try looking in the repo root .tree/
  git_common_dir=$(git rev-parse --git-common-dir)
  repo_root=$(cd "$(dirname "$git_common_dir")" && pwd)
  
  if [[ -d "$repo_root/.tree/$worktree_path" ]]; then
    echo "Found worktree at $repo_root/.tree/$worktree_path"
    worktree_path="$repo_root/.tree/$worktree_path"
  else
    echo "Error: worktree directory '$worktree_path' does not exist" >&2
    exit 1
  fi
fi

echo "Rebasing main onto '$branch'..."
git rebase "$branch" || {
  echo "Error: rebase failed" >&2
  exit 1
}

echo "Pushing main..."
git push || {
  echo "Error: push failed" >&2
  exit 1
}

echo "Removing worktree at '$worktree_path'..."
git worktree remove -f "$worktree_path" || {
  echo "Error: failed to remove worktree" >&2
  exit 1
}

echo "Deleting branch '$branch'..."
git branch -d "$branch" || {
  echo "Error: failed to delete branch (may not be fully merged)" >&2
  exit 1
}

echo "âœ“ Successfully completed main gulp workflow"
